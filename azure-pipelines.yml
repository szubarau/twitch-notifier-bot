name: $(Date:yyyyMMdd)$(Rev:.r)
trigger: none

schedules:
- cron: "*/15 * * * *"  # Проверка каждые 15 минут
  displayName: "Twitch Stream Check"
  branches:
    include: [main]
  always: true

variables:
- group: twitch_bot_secrets
- name: PIP_CACHE_DIR
  value: $(Pipeline.Workspace)/.pip-cache

pool:
  vmImage: 'ubuntu-latest'

jobs:
- job: StreamMonitor
  timeoutInMinutes: 10
  steps:

    # Установка Python
    - task: UsePythonVersion@0
      inputs:
        versionSpec: '3.9'
        addToPath: true
      displayName: 'Use Python 3.9'

    # === Поиск и хэширование requirements.txt ===
    - bash: |
        FILE=$(find . -type f -name "requirements.txt" | head -n 1)
        if [[ -f "$FILE" ]]; then
          echo "Found requirements.txt at: $FILE"
          HASH=$(sha256sum "$FILE" | cut -d ' ' -f1)
          echo "##vso[task.setvariable variable=REQ_HASH]$HASH"
          echo "##vso[task.setvariable variable=REQ_PATH]$FILE"
        else
          echo "No requirements.txt found"
          echo "##vso[task.setvariable variable=REQ_HASH]no-file"
          echo "##vso[task.setvariable variable=REQ_PATH]not-found"
        fi
      displayName: 'Find and hash requirements.txt'

    # === Кэширование pip ===
    - task: Cache@2
      inputs:
        key: |
          pip | "$(Agent.OS)" | requirements.txt | $(REQ_HASH)
        path: $(PIP_CACHE_DIR)
        restoreKeys: |
          pip | "$(Agent.OS)" | requirements.txt
      displayName: 'Cache pip dependencies'

    # === Установка зависимостей ===
    - script: |
        echo "Installing dependencies from $(REQ_PATH)"
        pip install --upgrade pip
        if [ "$(REQ_PATH)" != "not-found" ]; then
          pip install -r "$(REQ_PATH)"
        else
          echo "requirements.txt not found — skipping install"
        fi
      displayName: 'Install dependencies'

    # === Запуск Twitch-бота ===
    - script: |
        echo "Running Twitch bot..."
        PYTHONPATH=src python src/main.py
      displayName: 'Run Twitch Bot'
      env:
        TWITCH_CLIENT_ID: $(TWITCH_CLIENT_ID)
        TWITCH_CLIENT_SECRET: $(TWITCH_CLIENT_SECRET)
        TELEGRAM_BOT_TOKEN: $(TELEGRAM_BOT_TOKEN)
        TELEGRAM_CHANNEL_ID: $(TELEGRAM_CHANNEL_ID)
