# .azure/pipelines/azure-pipelines.yml
name: $(Date:yyyyMMdd)$(Rev:.r)
trigger: none

schedules:
- cron: "*/5 * * * *"  # Проверка каждые 5 минут
  displayName: "Twitch Stream Check"
  branches:
    include: [main]
  always: true

variables:
- group: twitch_bot_secrets  # Подключение переменных
- name: PIP_CACHE_DIR
  value: $(Pipeline.Workspace)/.pip-cache

pool:
  vmImage: 'ubuntu-latest'

jobs:
- job: StreamMonitor
  timeoutInMinutes: 10  # Лимит выполнения
  steps:
  
  # Установка Python
  - task: UsePythonVersion@0
    inputs:
      versionSpec: '3.9'
      addToPath: true

  # Кэширование зависимостей
  - task: Cache@2
    inputs:
      key: 'pip | "$(Agent.OS)" | requirements.txt'
      path: $(PIP_CACHE_DIR)

  # Установка пакетов
  - script: |
      pip install --upgrade pip
      pip install -r requirements.txt
    displayName: 'Install dependencies'

  # Основной запуск бота
  - script: |
      python src/main.py
    env:
      TWITCH_CLIENT_ID: $(TWITCH_CLIENT_ID)
      TWITCH_CLIENT_SECRET: $(TWITCH_CLIENT_SECRET)
      TELEGRAM_BOT_TOKEN: $(TELEGRAM_BOT_TOKEN)
      TELEGRAM_CHANNEL_ID: $(TELEGRAM_CHANNEL_ID)
    displayName: 'Run Twitch Bot'